<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-快速开始/快速部署">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">一、单机部署 | Mindcrest Ocean</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openfusionx.github.io/mindcrestocean/docs/current/快速开始/快速部署"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="一、单机部署 | Mindcrest Ocean"><meta data-rh="true" name="description" content="基础环境依赖"><meta data-rh="true" property="og:description" content="基础环境依赖"><link data-rh="true" rel="icon" href="/mindcrestocean/img/brand.svg"><link data-rh="true" rel="canonical" href="https://openfusionx.github.io/mindcrestocean/docs/current/快速开始/快速部署"><link data-rh="true" rel="alternate" href="https://openfusionx.github.io/mindcrestocean/docs/current/快速开始/快速部署" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://openfusionx.github.io/mindcrestocean/en/docs/current/快速开始/快速部署" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://openfusionx.github.io/mindcrestocean/docs/current/快速开始/快速部署" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/mindcrestocean/blog/rss.xml" title="Mindcrest Ocean RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mindcrestocean/blog/atom.xml" title="Mindcrest Ocean Atom Feed"><link rel="stylesheet" href="/mindcrestocean/assets/css/styles.4c33519f.css">
<link rel="preload" href="/mindcrestocean/assets/js/runtime~main.4c55b0e9.js" as="script">
<link rel="preload" href="/mindcrestocean/assets/js/main.2671ce09.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a style="text-decoration:none" href="/mindcrestocean/"><div style="display:flex;align-items:center"><img src="/mindcrestocean/img/brand.png" alt="Brand Logo" style="width:70px;height:auto;object-fit:contain"><img src="/mindcrestocean/img/brandname.png" alt="Brand Text Logo" style="width:113px;height:30px;margin-left:18px;margin-right:46px"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/mindcrestocean/docs/current/概览">文档</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/mindcrestocean/docs/current/快速开始/快速部署" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/mindcrestocean/en/docs/current/快速开始/快速部署" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-GB">English</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://github.com/openfusionx/MindcrestOcean-githubio" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/openfusionx/MindcrestOcean-githubio" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/mindcrestocean/docs/current/概览">概览</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/mindcrestocean/docs/current/category/quick-start">快速开始</a><button aria-label="打开/收起侧边栏菜单「快速开始」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mindcrestocean/docs/current/快速开始/概念">概念</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/mindcrestocean/docs/current/快速开始/准备环境">准备环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mindcrestocean/docs/current/快速开始/快速部署">部署手册</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/mindcrestocean/docs/current/category/configuration-center">使用手册</a><button aria-label="打开/收起侧边栏菜单「使用手册」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/mindcrestocean/docs/current/category/loader">架构设计</a><button aria-label="打开/收起侧边栏菜单「架构设计」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/mindcrestocean/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/mindcrestocean/docs/current/category/quick-start"><span itemprop="name">快速开始</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">部署手册</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>一、单机部署</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基础环境依赖">基础环境依赖<a href="#基础环境依赖" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><ul><li>docker == 1.27.x   docker 存储目录&gt;1T</li><li>kubernetes = 1.21~1.25</li><li>kubectl == 1.24 </li><li>nfs/ceph等分布式文件系统 挂载到每台机器的 /data/k8s/ （单机可忽略）</li><li>数据库接口地址 mysql，没有可忽略使用cube-studio自带的</li><li>单机 磁盘&gt;=1000G 单机磁盘容量要求不大，仅做镜像容器的的存储  </li><li>控制端机器1-2台 cpu&gt;=16 mem&gt;=32G  </li><li>任务端cpu/gpu机器	根据需要自行配置和扩容，gpu安装对应厂商的要求安装好机器驱动</li><li>IB/RDMA网络	自动安装机器驱动和IB卡</li><li>系统 ubuntu 20.04 ubuntu 22.04 或者centos7或者centos8</li></ul><p>平台完成部署之后如下:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署提前预备内容">部署提前预备内容<a href="#部署提前预备内容" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>1、分布式存储，挂载到/data/k8s目录下（单机可忽略）。</p><p>nfs分布式存储示例：参考cube-studio/install/kubernetes/nfs/NFS离线部署.md</p><p>2、私有镜像仓库，在每台机器的docker配置中添加Insecure Registries(体验可忽略)</p><p>参考：cube-studio/install/harbor/readme.md</p><p>3、gpu机器要安装nvidia-docker2，gpu机器安装对应的驱动，IB设备也需要安装对应的驱动(cpu机器可忽略)</p><p>参考：cube-studio/install/rancher</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1未有k8s的用户">1、未有k8s的用户<a href="#1未有k8s的用户" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>可以参考视频，先使用rancher部署k8s，再部署cube-studio</p><p><a href="https://www.bilibili.com/video/BV18r4y147oj/" target="_blank" rel="noopener noreferrer">单机部署视频</a></p><p>也可以查看使用rancher部署k8s的文档，可以查看cube-studio/install/kubernetes/rancher/readme.md</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2对于已有k8s的用户">2、对于已有k8s的用户<a href="#2对于已有k8s的用户" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>1、对于ipvs模式的k8s，
（1）要将start.sh脚本最后面的<code>kubectl patch</code>注释掉。然后手动释放istio-system命名空间 istio-ingressgateway,服务类型改为NodePort。
（2）将配置文件install/kubernetes/cube/overlays/config/config.py中的K8S_NETWORK_MODE 改为ipvs</p><p>2、服务可用端口范围要放大到10~60000</p><p>3、平台入口是istio-system命名空间 istio-ingressgateway，不是cube-studio的前端部分</p><p>平台部署命令：</p><p>将k8s集群的kubeconfig文件复制到install/kubernetes/config文件中,对于双网卡的同学，记得rancher里面current-context切换为内网的连接形式，然后执行如下命令，其中xx.xx.xx.xx为机器内网的ip（不是外网ip）</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在k8s worker机器上执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sh start.sh xx.xx.xx.xx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>kubeconfig文件位置</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/direct/20677dc5fefb41ca99969144d158e721.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3隔离内网部署">3、隔离内网部署<a href="#3隔离内网部署" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>4、创建企业自己的镜像仓库，在web界面，在线开发-镜像仓库，添加自己的仓库地址和账号密码。注意hubsecret不要删除</p><p>5、修改config.py文件中REPOSITORY_ORG为自己的镜像仓库地址，HUBSECRET添加自己上一步配置的k8s hubsecret，并将配置更新到infra/kubeflow-dashboard-config的configmap中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="修改为非80端口">修改为非80端口<a href="#修改为非80端口" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>修改istio-system命名空间下面名为istio-ingressgateway的service，将服务类型改为NodePort。将80端口的nodePort改为其他可以访问的端口，注意不要删除80端口的配置，因为在gateway中会读取这个80参数。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="域名访问">域名访问<a href="#域名访问" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>修改 install/kubernetes/gateway.yaml,将其中的host参数 *  修改为域名。然后重新部署这个gateway.yaml文件</p><p>修改域名后notebook要重新reset才能打开。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内部ip和外部ip">内部ip和外部ip<a href="#内部ip和外部ip" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-反向代理istio-ingressgateway">nginx 反向代理istio-ingressgateway<a href="#nginx-反向代理istio-ingressgateway" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>有时候浏览器只能打开物理机ip，而我们部署cube-studio使用的是虚拟机。需要添加nginx代理，注意nginx访问超时时常要设置大一些，不然websocket协议的webshell执行命令会失败</p><p>nginx配置参考：myapp/install/kubernetes/nginx-https/nginx.conf</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署后排查">部署后排查<a href="#部署后排查" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p>0、在内网中会存在，kubectl工具不存在，无法下载，可以查看修改下start.sh脚本，手动下载kubectl。</p><p>1、如果k8s采用的是ipvs网络模式，修改istio-ingressgateway为nodeport模式，而不是externalIPs模式，并在配置文件config.py中将iptables修改为ipvs</p><p>2、查看机器lable是否添加</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl label node $node train=true cpu=true notebook=true service=true org=public istio=true knative=true kubeflow=true kubeflow-dashboard=true mysql=true redis=true monitoring=true logging=true --overwrite</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3、pv和pvc是否绑定。有些k8s平台会自动为pvc添加Storage Classes，需要对应pv也添加完成绑定</p><p>4、kube-system命名空间coredns是否正常，</p><ul><li>4.1、可以放开防火墙</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/sbin/iptables -P FORWARD ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/sbin/iptables -P INPUT ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/sbin/iptables -P OUTPUT ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>放开防火墙后重启coredns 的pod</p><ul><li>4.2、可以查看53端口是否被占用，比如bind服务，关闭主机原有53端口服务(注意机器重启后可能原53端口占用的服务被重新打开)。</li></ul><p>5、infra命名空间其他组件是否成功，会链接mysql完成数据库初始化。kubeflow数据库由kubeflow-dashboard.infra组件完成初始化。</p><ul><li>5.1 数据库如果库表不全，可以把对应库删掉，重启相应组件。rm -rf /data/k8s/infra/mysql，然后重启mysql，再重启kubeflow-dashboard</li><li>5.2  如果kubeflow-dashboard报core dump，则可能是linux系统内核版本太低，需要升级系统内核</li></ul><p>6、istio-system空间，istio-ingressgateway的svc是否externalIPs形式暴露了内网ip。 如果有双网卡， 在执行sh start.sh xx.xx.xx.xx时，使用的是内网ip，浏览器打开的是外网ip</p><p>6、istio-ingressgateway暴露80以后，仍然无法打开，可能原因（1）80被内网封禁（2）80倍其他服务占用（3）没有禁用nginx-ingress (4)防火墙限制，可以<code>/sbin/iptables -P FORWARD ACCEPT</code></p><p>7、istio-ingressgateway暴露其他端口，如果80端口被占用了，可以修改 istio-system/svc/istio-ingressgateway 类型为NodePort</p><p>内网机器需要安装了docker，docker-compose，iptables</p><h1>二、内网离线部署</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1内网中有可以联网的机器">1.内网中有可以联网的机器<a href="#1内网中有可以联网的机器" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="联网机器设置代理服务器">联网机器设置代理服务器<a href="#联网机器设置代理服务器" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>联网机器上设置nginx代理软件源，参考install/kubernetes/nginx-https/apt-yum-pip-source.conf</p><p>启动nginx代理访问</p><p>需要监听80和443端口</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --name proxy-repo -d --restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">always --network</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">host -v </span><span class="token environment constant" style="color:#36acaa">$PWD</span><span class="token plain">/nginx-https/apt-yum-pip-source.conf:/etc/nginx/nginx.conf nginx </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在内网机器上配置host">在内网机器上配置host<a href="#在内网机器上配置host" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>host</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    mirrors.aliyun.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    ccr.ccs.tencentyun.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    registry-1.docker.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    auth.docker.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    hub.docker.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    www.modelscope.cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    modelscope.oss-cn-beijing.aliyuncs.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    archive.ubuntu.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    security.ubuntu.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    cloud.r-project.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    deb.nodesource.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">    docker-76009.sz.gfp.tencent-cloud.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>添加新的host要重启下kubelet   docker restart kubelet</p><p>如果代理机器没法占用80和443，需要使用iptable尝试转发。</p><p>iptables</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> iptables -t nat -A PREROUTING -p tcp --dport </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> -d mirrors.aliyun.com -j DNAT --to-destination </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的IP地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">出口服务器的端口</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="k8s配置域名解析">k8s配置域名解析<a href="#k8s配置域名解析" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>k8s中修改 kube-system命名空间，coredns的configmap，添加 需要访问的地址 的地址映射</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;Corefile&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.:53 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        health {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          lameduck 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        kubernetes cluster.local in-addr.arpa ip6.arpa {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          pods insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          fallthrough in-addr.arpa ip6.arpa</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        # 自定义host</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        hosts {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &lt;出口服务器的IP地址&gt;    mirrors.aliyun.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    ccr.ccs.tencentyun.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    registry-1.docker.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    auth.docker.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    hub.docker.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    www.modelscope.cn</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    modelscope.oss-cn-beijing.aliyuncs.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    archive.ubuntu.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    security.ubuntu.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    cloud.r-project.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    deb.nodesource.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &lt;出口服务器的IP地址&gt;    docker-76009.sz.gfp.tencent-cloud.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          fallthrough</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        prometheus :9153</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        forward . </span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">/etc/resolv.conf</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        cache 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        loadbalance</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    } # STUBDOMAINS - Rancher specific change</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重启coredns的pod</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/openfusionx/MindcrestOcean-githubio/docs/快速开始/快速部署.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/mindcrestocean/docs/current/快速开始/准备环境"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">准备环境</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/mindcrestocean/docs/current/category/configuration-center"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Configuration Center</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#基础环境依赖" class="table-of-contents__link toc-highlight">基础环境依赖</a></li><li><a href="#部署提前预备内容" class="table-of-contents__link toc-highlight">部署提前预备内容</a><ul><li><a href="#1未有k8s的用户" class="table-of-contents__link toc-highlight">1、未有k8s的用户</a></li><li><a href="#2对于已有k8s的用户" class="table-of-contents__link toc-highlight">2、对于已有k8s的用户</a></li><li><a href="#3隔离内网部署" class="table-of-contents__link toc-highlight">3、隔离内网部署</a></li></ul></li><li><a href="#修改为非80端口" class="table-of-contents__link toc-highlight">修改为非80端口</a></li><li><a href="#域名访问" class="table-of-contents__link toc-highlight">域名访问</a></li><li><a href="#内部ip和外部ip" class="table-of-contents__link toc-highlight">内部ip和外部ip</a></li><li><a href="#nginx-反向代理istio-ingressgateway" class="table-of-contents__link toc-highlight">nginx 反向代理istio-ingressgateway</a></li><li><a href="#部署后排查" class="table-of-contents__link toc-highlight">部署后排查</a></li><li><a href="#1内网中有可以联网的机器" class="table-of-contents__link toc-highlight">1.内网中有可以联网的机器</a><ul><li><a href="#联网机器设置代理服务器" class="table-of-contents__link toc-highlight">联网机器设置代理服务器</a></li><li><a href="#在内网机器上配置host" class="table-of-contents__link toc-highlight">在内网机器上配置host</a></li><li><a href="#k8s配置域名解析" class="table-of-contents__link toc-highlight">k8s配置域名解析</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/mindcrestocean/docs/current/概览">文档</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/openfusionx/MindcrestOcean-githubio" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/openfusionx/MindcrestOcean-githubio/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright  2025 openfusionx</div></div></div></footer></div>
<script src="/mindcrestocean/assets/js/runtime~main.4c55b0e9.js"></script>
<script src="/mindcrestocean/assets/js/main.2671ce09.js"></script>
</body>
</html>